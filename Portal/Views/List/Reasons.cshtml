@using Portal.Models.ViewModels;
@model ReasonVM;
@{
    ViewData["Title"] = "جميع الأسباب";
}

<!-- Content Page -->
<div class="container-xxl flex-grow-1 container-p-y">
    <div class="row gy-4">
        <div class="card">
            <div class="card-header">
                <h4>قائمة بجميع الأسباب</h4>
                <button class="btn btn-primary float-start" data-bs-toggle="modal" data-bs-target="#AddReasonModel">
                    <i class="bx bx-plus"></i>
                    <span class="d-lg-inline-block">أضافة سبب جديد</span>
                </button>
                <button class="btn btn-outline-dark float-end" id="PrintTableBtn">
                    <i class="bx bx-printer"></i>
                    <span class="d-lg-inline-block">طباعة الجدول</span>
                </button>
            </div>
            <div class="card-body">
                <table id="userTable" class="table  table-sm table-bordered table-striped">
                    <thead>
                        <tr>
                            <th scope="col">السبب</th>
                            <th scope="col">مبلغ الصرف</th>
                            <th scope="col">تاريخ الإضافة</th>
                            <th scope="col">التحكم</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Reasons.Any())
                        {
                            @foreach (var item in Model.Reasons)
                            {
                                <tr>
                                    <td>@item.Name</td>
                                    <td>@item.Amount ريال</td>
                                    <td>@item.Date</td>
                                    <td>
                                        <a style="color:azure" onclick="Edit('@item.Id','@item.Id','@item.Id')" class="btn btn-dark">تعديل السبب</a>
                                        <a style="color:azure" onclick="Delete('@item.Id')" class="btn btn-danger">حذف</a>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" class="text-center">لا يوجد أسباب</td>
                            </tr>
                        }

                    </tbody>
                </table>

            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="AddReasonModel" tabindex="-1" aria-labelledby="AddReasonLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="AddReasonLabel">أضافة سبب جديد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form asp-action="CreateReason" asp-controller="Create" method="post">
                    <div class="mb-3">
                        <label class="form-label" for="Reason">السبب</label>
                        <input type="search" class="form-control" name="Reason" id="Reason" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="Reason">مبلغ الصرف</label>
                        <input type="search" class="form-control" name="Amount" id="Amount" required>
                    </div>
                    <button type="submit" class="btn btn-primary">أضافة</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">الغاء</button>
                </form>
            </div>
        </div>
    </div>
</div>



@section Stylesheet {
    <link rel="stylesheet" href="~/assets/vendor/libs/datatables-bs5/datatables.bootstrap5.css" />
    <link rel="stylesheet" href="~/assets/vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css" />
    <!-- Vendors CSS -->
    <link rel="stylesheet" href="~/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="~/assets/vendor/libs/typeahead-js/typeahead.css" />
    <link rel="stylesheet" href="~/assets/vendor/libs/datatables-bs5/datatables.bootstrap5.css" />
    <link rel="stylesheet" href="~/assets/vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css" />
    <link rel="stylesheet" href="~/assets/vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css" />
    <link rel="stylesheet" href="~/assets/vendor/libs/select2/select2.css" />
    <link rel="stylesheet" href="~/assets/vendor/libs/formvalidation/dist/css/formValidation.min.css" />
    <link rel="stylesheet" href="~/assets/vendor/libs/sweetalert2/sweetalert2.css">

}

@section Scripts {
    <script src="~/assets/vendor/libs/sweetalert2/sweetalert2.js"></script>
    <script src="~/assets/vendor/libs/datatables/jquery.dataTables.js"></script>
    <script src="~/assets/vendor/libs/datatables-bs5/datatables-bootstrap5.js"></script>
    <script src="~/assets/vendor/libs/datatables-responsive/datatables.responsive.js"></script>
    <script src="~/assets/vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.js"></script>
    <script src="~/assets/vendor/libs/moment/moment.js"></script>
    <script src="~/assets/vendor/libs/datatables/jquery.dataTables.js"></script>
    <script src="~/assets/vendor/libs/datatables-bs5/datatables-bootstrap5.js"></script>
    <script src="~/assets/vendor/libs/datatables-responsive/datatables.responsive.js"></script>
    <script src="~/assets/vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.js"></script>
    <script src="~/assets/vendor/libs/datatables-buttons/datatables-buttons.js"></script>
    <script src="~/assets/vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.js"></script>
    <script src="~/assets/vendor/libs/jszip/jszip.js"></script>
    <script src="~/lib/datatablesRTL/pdfmake.js"></script>
    <script src="~/lib/datatablesRTL/vfs_fonts.js"></script>
    <script src="~/lib/datatablesRTL/buttons.print.min.js"></script>
    <script src="~/lib/datatablesRTL/buttons.html5.min.js"></script>
    <script src="~/assets/vendor/libs/select2/select2.js"></script>
    <script src="~/assets/vendor/libs/formvalidation/dist/js/FormValidation.min.js"></script>
    <script src="~/assets/vendor/libs/formvalidation/dist/js/plugins/Bootstrap5.min.js"></script>
    <script src="~/assets/vendor/libs/formvalidation/dist/js/plugins/AutoFocus.min.js"></script>
    <script src="~/assets/vendor/libs/cleavejs/cleave.js"></script>
    <script src="~/assets/vendor/libs/cleavejs/cleave-phone.js"></script>


    <script>

        $(document).ready(function () {

            // DataTable userTable
            $('#userTable').DataTable({
                paging: false,
                columnDefs: [
                    // Center align both header and body content of columns 1, 2 & 3
                    { className: "dt-center", targets: [0, 1, 2,3] }
                ]
            });

        });

        var AddStatus = '@Model.AddStatus';
        var UpdateStatus = '@Model.UpdateStatus';
        var DeleteStatus = '@Model.DeleteStatus';

        if (AddStatus === "True") {
            Swal.fire(
                'تم!',
                'تمت الاضافة بنجاح',
                'success'
            );
        } else if (AddStatus === "False") {
            Swal.fire(
                'خطأ!',
                'حدث خطأ',
                'error'
            );
        }

        if (UpdateStatus === "True") {
            Swal.fire(
                'تم!',
                'تم التعديل بنجاح',
                'success'
            );
        } else if (UpdateStatus === "False") {
            Swal.fire(
                'خطأ!',
                'حدث خطأ',
                'error'
            );
        }

        if (DeleteStatus === "True") {
            Swal.fire(
                'تم!',
                'تم الحذف بنجاح',
                'success'
            );
        } else if (DeleteStatus === "False") {
            Swal.fire(
                'خطأ!',
                'حدث خطأ',
                'error'
            );
        }




        //function Delete(id) with ajax swal2 to confirm the delete by enter the password of the user who logged in.
        function Delete(id) {
            Swal.fire({
                title: 'هل انت متأكد؟',
                text: "لن تتمكن من التراجع عن هذا الاجراء!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'نعم, احذفه!',
                cancelButtonText: 'الغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'ادخل كلمة المرور',
                        input: 'password',
                        inputAttributes: {
                            autocapitalize: 'off'
                        },
                        showCancelButton: true,
                        confirmButtonText: 'حذف',
                        showLoaderOnConfirm: true,
                        preConfirm: (password) => {
                            // call ajax.
                            return $.ajax({
                                url: "@Url.Action("DeleteReason", "Create")",
                                type: "POST",
                                data: { id: id, password: password },
                                success: function (data) {
                                    console.log(data);
                                    if (data == "1") {
                                        return "1";
                                    }
                                    else if (data == "2") {
                                        return "2";
                                    }
                                    else {
                                        return "0";
                                    }
                                }
                            });


                        },
                        allowOutsideClick: () => !Swal.isLoading()
                    }).then((result) => {
                        if (result.isConfirmed) {
                            if (result.value == "1") {
                                //success message and close the swal2 after 2 seconds.
                                Swal.fire(
                                    'تم!',
                                    'تم الحذف بنجاح',
                                    'success'
                                )
                                setTimeout(function () {
                                    location.reload();
                                }, 2000);

                            }
                            else if (result.value == "2") {
                                Swal.fire(
                                    'خطأ!',
                                    'كلمة المرور غير صحيحة',
                                    'error'
                                );
                            }
                            else {
                                Swal.fire(
                                    'خطأ!',
                                    'حدث خطأ',
                                    'error'
                                );
                            }
                        }
                    })
                }
            })
        }

        function Edit(id, name, Amount) {
            // Show Swal2 to edit the reason.
            Swal.fire({
                title: 'تعديل السبب',
                html:
                    '<input id="swal-input1" class="swal2-input" value="' + name + '">' +
                    '<input id="swal-input2" class="swal2-input" value="' + Amount + '">',
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'تعديل',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    var ReasonInput = $("#swal-input1").val();
                    if (!ReasonInput) {
                        Swal.showValidationMessage('الرجاء إدخال السبب');
                        return;
                    }

                    var AmountInput = $("#swal-input2").val();
                    if (!AmountInput) {
                        Swal.showValidationMessage('الرجاء إدخال مبلغ الاشتراك');
                        return;
                    }

                    // If the amount is less than or equal to 0.
                    if (AmountInput <= 0) {
                        Swal.showValidationMessage('مبلغ الاشتراك يجب أن يكون أكبر من 0');
                        return;
                    }
                    // If the amount is not a number.
                    if (isNaN(AmountInput)) {
                        Swal.showValidationMessage('مبلغ الاشتراك يجب أن يكون رقم');
                        return;
                    }

                    // Check if the input is the same as the old one.
                    if (ReasonInput === name && parseFloat(Amount) === parseFloat(AmountInput)) {
                        Swal.showValidationMessage('لا يوجد تعديل');
                        return;
                    }
                    var data = {
                        id: id,
                        Reason: ReasonInput,
                        Amount: AmountInput
                    };
                    return $.ajax({
                        url: "@Url.Action("EditReason", "Create")",
                        type: 'POST',
                        data: data,
                        success: function (data) {
                            console.log(data);
                            if (data === '1') {
                                return '1';
                            } else {
                                return '0';
                            }
                        }
                    });
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log(result.value);
                    if (result.value === 1) {
                        Swal.fire({
                            title: 'تم!',
                            text: 'تم التعديل بنجاح',
                            icon: 'success'
                        });
                        setTimeout(function () {
                            location.reload();
                        }, 2000);
                    } else {
                        Swal.fire('خطأ!', 'حدث خطأ', 'error');
                    }
                }
            });
        }
        $('#PrintTableBtn').on('click', function () {
            // Get the DataTable instance
            var table = $('#userTable').DataTable();

            var Title = 'جميع الأسباب في النظام';

            // Export data with column header formatting
            var data = table.buttons.exportData({
                format: {
                    header: function (data, columnIdx) {
                        return data;
                    }
                }
            });

            // Open a new window for printing
            var printWin = window.open('', '', 'width=1000,height=600');

            // Print the data on the page after a short delay
            printWin.onload = function () {
                setTimeout(function () {
                    printWin.document.write('<html st dir="rtl" style="font-family:Adobe Arabic;">');
                    printWin.document.write('<title>' + Title + '</title>');

                    printWin.document.write('<h1>' + Title + '</h1>');
                    printWin.document.write('<table border="2" dir="rtl" class="table table-striped table-bordered" style="width:100%">');
                    printWin.document.write('<thead>');
                    printWin.document.write('<tr>');
                    // Use the column headers from DataTable
                    $.each(data.header, function (i, header) {
                        if (i !== 2) {
                            printWin.document.write('<th>' + header + '</th>');
                        }
                    });
                    printWin.document.write('</tr>');
                    printWin.document.write('</thead>');
                    printWin.document.write('<tbody>');
                    $.each(data.body, function (i, row) {
                        printWin.document.write('<tr>');
                        $.each(row, function (j, cell) {
                            // Exclude the last column (index 4)
                            if (j !== 2) {
                                printWin.document.write('<td>' + cell + '</td>');
                            }
                        });
                        printWin.document.write('</tr>');
                    });

                    printWin.document.write('</tbody>');
                    printWin.document.write('</table>');

                    printWin.document.write('<h3>عدد الأسباب في النظام : ' + data.body.length + '</h3>');






                    printWin.document.close();

                    // Focus on the print window and initiate the print
                    printWin.focus();
                    printWin.print();
                    printWin.close();
                }, 500); // Adjust the delay time as needed
            };
        });

    </script>


}
