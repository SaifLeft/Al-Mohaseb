@model TransferMoneyVM;
@{
    ViewData["Title"] = "تحويل مبلغ";
}

<!-- Content Page -->
<div class="container-xxl flex-grow-1 container-p-y ">
    <div class="d-flex align-items-center justify-content-center h-px-600">
        <form id="formRequest" asp-action="CreateTransferMoney" asp-controller="Create" class="card w-px-600 border rounded p-3 p-md-5" method="POST">
            <h5 class="mb-5">تحويل مبلغ من رصيد الى رصيد اخر</h5>
            <div class="mb-3">
                <label class="form-label">
                    التاريخ
                </label>
                <input type="text"
                       id="Date"
                       name="Date"
                       placeholder="yyyy-MM-dd" readonly="readonly"
                       required
                       class="form-control" />
            </div>
            <div class="mb-3">
                <label class="form-label" for="fullname">تحويل مبلغ من</label>
                <select class="select2 form-select" name="FromNameId" id="PersonSelect1">
                    <option value=""></option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label" for="fullname">الى</label>
                <select class="select2 form-select" name="ToNameId" id="PersonSelect2">
                    <option value=""></option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">المبلغ</label>
                <input type="number" id="Amount" name="Amount" class="form-control" placeholder="0.00">
            </div>
            <div class="mb-4">
                <label class="form-label">السبب</label>
                <textarea id="Description" name="Description" class="form-control" rows="2"></textarea>
            </div>
            <div class="mb-3">
                <a class="mt-3" asp-action="Names" asp-controller="List">
                    <i class="bx bxs-right-arrow"></i> العودة للصفحة الرئيسية
                </a>
                <button type="submit" class="btn btn-primary float-end">إنشاء</button>
            </div>
        </form>
    </div>
</div>



@section Stylesheet {
    <link rel="stylesheet" href="~/assets/vendor/libs/sweetalert2/sweetalert2.css">
    <link rel="stylesheet" href="~/assets/vendor/libs/datatables-bs5/datatables.bootstrap5.css" />
    <link rel="stylesheet" href="~/assets/vendor/libs/select2/select2.css" />
    <link rel="stylesheet" href="~/assets/vendor/libs/flatpickr/flatpickr.css">
    <link rel="stylesheet" href="~/assets/vendor/libs/formvalidation/dist/css/formValidation.css" />

}

@section Scripts {
    <script src="~/assets/vendor/libs/datatables/jquery.dataTables.js"></script>
    <script src="~/assets/vendor/libs/select2/select2.js"></script>
    <script src="~/assets/vendor/libs/formvalidation/dist/js/FormValidation.js"></script>
    <script src="~/assets/vendor/libs/formvalidation/dist/js/plugins/Bootstrap5.min.js"></script>
    <script src="~/assets/vendor/libs/formvalidation/dist/js/plugins/AutoFocus.min.js"></script>
    <script src="~/assets/vendor/libs/sweetalert2/sweetalert2.js"></script>
    <script src="~/assets/vendor/libs/flatpickr/flatpickr.js"></script>


    <script>

        $(document).ready(function () {
            // Select2 initialization
            $('.select2').each(function () {
                $(this).select2({
                    placeholder: 'اختر',
                    allowClear: true
                });
            });
            $('#Date').flatpickr({
                dateFormat: 'Y-m-d',
                monthSelectorType: 'static',
                maxDate: 'today'
            });

            SetNames();


            // Event handlers
            $('#PersonSelect1').on('change', function () {
                synchronizeDropdowns($(this), $('#PersonSelect2'));
            });

            $('#PersonSelect2').on('change', function () {
                synchronizeDropdowns($(this), $('#PersonSelect1'));
            });

            function synchronizeDropdowns(sourceDropdown, targetDropdown) {
                var selectedId = sourceDropdown.val();
                var targetSelectedId = targetDropdown.val();

                removeSelectedId(selectedId, targetDropdown);

                if (selectedId !== null && targetSelectedId !== null && selectedId !== targetSelectedId) {
                    // Check if the change event is not already in progress to avoid the infinite loop
                    if (!targetDropdown.data('changing')) {
                        targetDropdown.data('changing', true);
                        targetDropdown.val(targetSelectedId).trigger("change");
                        targetDropdown.data('changing', false);
                    }
                }
            }


            const formAuthentication = document.querySelector('#formRequest');

            if (formAuthentication) { // Check if formRequest exists and is not empty
                const fv = FormValidation.formValidation(formAuthentication, {
                    fields: {
                        Date: {
                            validators: {
                                notEmpty: {
                                    message: 'الرجاء اختيار التاريخ'
                                },
                                date: {
                                    format: 'YYYY-MM-DD',
                                    message: 'الرجاء ادخال تاريخ صحيح'
                                }
                            }
                        },
                        PersonSelect1: {
                            validators: {
                                notEmpty: {
                                    message: 'الرجاء اختيار الشخص المحول منه'
                                }
                            }
                        },
                        PersonSelect2: {
                            validators: {
                                notEmpty: {
                                    message: 'الرجاء اختيار الشخص المحول اليه'
                                }
                            }
                        },
                        Amount: {
                            validators: {
                                notEmpty: {
                                    message: 'الرجاء ادخال المبلغ'
                                },
                                numeric: {
                                    message: 'الرجاء ادخال قيمة صحيحة بالأرقام مثل 150.654'
                                }
                            }
                        },
                        Description: {
                            validators: {
                                notEmpty: {
                                    message: 'الرجاء ادخال الوصف'
                                }
                            }
                        }
                    },
                    plugins: {
                        trigger: new FormValidation.plugins.Trigger(),
                        bootstrap5: new FormValidation.plugins.Bootstrap5({
                            eleValidClass: '',
                            rowSelector: '.mb-3'
                        }),
                        submitButton: new FormValidation.plugins.SubmitButton(),
                        defaultSubmit: new FormValidation.plugins.DefaultSubmit(),
                        autoFocus: new FormValidation.plugins.AutoFocus()
                    },
                    init: instance => {
                        instance.on('plugins.message.placed', function (e) {
                            if (e.element.parentElement && e.element.parentElement.classList.contains('input-group')) {
                                e.element.parentElement.insertAdjacentElement('afterend', e.messageElement);
                            }
                        });
                    }
                });
            } else {
                console.error('Form #formAuthentication not found.');
            }

            // if formAuthentication is valid then call ConfirmTransfer()
            formAuthentication.addEventListener('submit', function (event) {
                console.log('Form submitted');
                event.preventDefault();
                fv.validate().then(function (status) {
                    if (status === 'Valid') {
                        ConfirmTransfer();
                    }
                });
            });




        });
        function GetNames() {
            var result;
            $.ajax({
                url: '@Url.Action("GetNames", "List")',
                type: 'GET',
                cache: true,
                dataType: 'json',
                async: false, // Wait for the request to complete before proceeding
                success: function (data) {
                    result = data;
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                }
            });
            return result;
        }
        function populateDropdown(nameList, dropdown) {
            dropdown.empty();
            $.each(nameList, function () {
                dropdown.append($("<option />").val(this.id).text(this.name));
            });
        }
        function removeSelectedId(id, dropdown) {
            var nameList = GetNames();
            nameList = nameList.filter(function (item) {
                return item.id != id;
            });
            populateDropdown(nameList, dropdown);

        }
        function SetNames() {
            var nameList = GetNames();
            var dropdown1 = $('#PersonSelect1');
            var dropdown2 = $('#PersonSelect2');
            dropdown1.empty();
            dropdown2.empty();
            populateDropdown(nameList, dropdown1);
            populateDropdown(nameList, dropdown2);
            dropdown1.val(null).trigger("change");
            dropdown2.val(null).trigger("change");
        }


        function ConfirmTransfer() {
            var date = $('#Date').val();
            var fromPersonId = $('#PersonSelect1').val();
            var toPersonId = $('#PersonSelect2').val();
            var amount = $('#Amount').val();
            var description = $('#Description').val();


            var isValid = ValidateTransferRequest();
            if (!isValid) {
                return;
            }



            var data = {
                date: date,
                FromNameId: fromPersonId,
                ToNameId: toPersonId,
                Amount: amount,
                Description: description
            };
            console.log(data);
            var Text = 'هل انت متأكد من صرف من رصيد ' + $('#PersonSelect1 option:selected').text() + ' الى رصيد ' + $('#PersonSelect2 option:selected').text() + ' مبلغ ' + amount + ' ريال؟';
            //sweetalert2
            Swal.fire({
                title: 'هل انت متأكد؟',
                text: Text,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم',
                cancelButtonText: 'لا'
            }).then(function (result) {
                if (result.isConfirmed) {
                    CreateTransfer(data);
                }
            });

        }
        function CreateTransfer(data) {
            $.ajax({
                url: '@Url.Action("CreateTransferMoneyAjax", "Create")',
                type: 'POST',
                dataType: 'json',
                data: data,
                success: function (data) {
                    if (data.status) {
                        Swal.fire({
                            title: 'تمت العملية بنجاح',
                            text: 'تمت عملية التحويل بنجاح',
                            icon: 'success',
                            confirmButtonText: 'حسناً'
                        }).then(function (result) {
                            if (result.isConfirmed) {
                                // Refresh the page
                                location.reload();
                            }
                        });
                    }
                    else {
                        Swal.fire({
                            title: 'فشلت العملية',
                            text: 'فشلت عملية التحويل',
                            icon: 'error',
                            confirmButtonText: 'حسناً'
                        });
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                }
            });
        }
        function ValidateTransferRequest() {
            var date = $('#Date').val();
            var fromPersonId = $('#PersonSelect1').val();
            var toPersonId = $('#PersonSelect2').val();
            var amount = $('#Amount').val();
            var description = $('#Description').val();
            // Validation
            if (date == '') {
                Swal.fire({
                    title: 'خطأ',
                    text: 'الرجاء ادخال التاريخ',
                    icon: 'error',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            if (fromPersonId == '' || fromPersonId == null) {
                Swal.fire({
                    title: 'خطأ',
                    text: 'الرجاء اختيار الشخص المحول منه',
                    icon: 'error',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            if (toPersonId == '' || toPersonId == null) {
                Swal.fire({
                    title: 'خطأ',
                    text: 'الرجاء اختيار الشخص المحول اليه',
                    icon: 'error',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            if (fromPersonId == toPersonId) {
                Swal.fire({
                    title: 'خطأ',
                    text: 'لا يمكن التحويل الى نفس الشخص',
                    icon: 'error',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            if (amount == '') {
                Swal.fire({
                    title: 'خطأ',
                    text: 'الرجاء ادخال المبلغ',
                    icon: 'error',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            if (description == '' || description == null) {
                Swal.fire({
                    title: 'خطأ',
                    text: 'الرجاء ادخال السبب',
                    icon: 'error',
                    confirmButtonText: 'حسناً'
                });
                return;
            }
            return true;
        }

    </script>


}
